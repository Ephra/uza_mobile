<?php

/**
 * Description of email
 *
 * @author Ephraim Swilla <swillae1@gmail.com>
 */
class email {

    private $to_email;
    private $subject;
    private $message;
    private $to_name;

    /**
     * 
     * @param Email $email Email address, separate by comma if more than one email
     */
    public function set_to_user_id($user_id) {
        global $db;
        $user = user::find_by_id($user_id);
        $user_info = array_shift($user);
          $this->to_email = $user_info->email;
         $this->to_name = $user_info->username;
    }
/**
 * @deprecated Dont use this if you set set_to_user(), its alternative to this
 * @param email $email
 * @return type
 */
    public function set_email($email){
   
            $user_info=  user::find_where('email="'.$email.'"');
            $user=  array_shift($user_info);
           $this->to_name=$user->username;
           $this->to_email=$user->email;
    }

    /**
     * 
     * @param String $subject
     */
    public function set_subject($subject) {


       $this->subject = $subject;
    }

    /**
     * @uses Set default email body to user 
     * @param String $message Simple text message ,default html is inside it
     */
    public function set_message($message) {


        $body = '
            <table width="60%" align="center" style=" background: #F8F8F8; font-size: 12px; font-family: Helvetica, Arial, Verdana, sans-serif;" >
    <thead>
        <tr>
            <th width="70" align="center">&nbsp;</th>
            <th width="462" align="left" scope="col" style=" height:40px; border:1px solid #FFF; padding:2%;" ><small>From tume ya maoni ya mabidiliko ya katiba</small></th>
          <th width="65" align="center" scope="col" style="">&nbsp;</th>
        </tr>
    </thead>
    <tfoot>
        <tr>
            <th height="23" scope="row">&nbsp;</th>
            <td>&nbsp;</td>
            <td></td>
        </tr>
    </tfoot>
    <tbody>
         <tr class="">
         <td height="141" align="center"  scope="row">&nbsp;</td>
           <td align="left" valign="top" style="padding:2%; font-size:14px; background:#FFF;">
           <p>Hi  ' . $this->to_name . '</p>
           ' . $message . '</td>
           <td align="center">&nbsp;</td>
        </tr>
   </tbody>
</table>';

      return  $this->message = $body;
    }
/**
 * @deprecated Dont use this is you set already set_message(); this is alternative to it
 * @param type $html
 * @return html body of email to be sent
 */
    public function set_html($html){
        if(!empty($this->message)){
            return $this->message=$html;
        }
    }

    /**
     * 
     * @return boolean True if sent
     * @throws Exception if you fail to set email, subject and message
     */
    public function send() {
     
        if (!$this->to_email || !$this->message || !$this->subject) {
           throw new Exception('You can not send email without setting first message, subject and to email');
        } else {
            require(RT."persistance/plugins/phpmailer/class.phpmailer.php");
            $mail = new PHPMailer();
            $mail->IsSMTP(); // send via SMTP
            $mail->SMTPAuth = true; // turn on SMTP authentication
            $email = $this->to_email; // Recipients email ID
            $name = $this->to_name;
            $mail->FromName = "Unnett";
            if(preg_match('/,/i', $email)){
                $array=  explode(',', $email);
                foreach ($array as $mail_to) {
                  $mail->AddAddress($mail_to);   
                }
            }  else {
                 $mail->AddAddress($email, $name);
            }         
            $mail->WordWrap = 50; // set word wrap
            $mail->IsHTML(true); // send as HTML
            $mail->Subject = $this->subject;
            $mail->Body = $this->message; //HTML Body
            //$mail->AltBody = "This is the body when user views in plain text format"; //Text Body
            if (!$mail->Send()) {
                // echo "Mailer Error: " . $mail->ErrorInfo;
                echo '<h4 class="alert_error">Email failed to be sent'.$mail->ErrorInfo.'.</h4>';
                return FALSE;
                exit();
            } else {
               // echo '<br /><h4 class="alert_success">Message has been sent</h4>';
                return TRUE;
                exit();
            }
        }
    }

}

?>
